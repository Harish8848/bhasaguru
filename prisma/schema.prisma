generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String           @id @default(cuid())
  name              String?
  email             String           @unique
  emailVerified     DateTime?
  image             String?
  profilePicture    String?
  phone             String?
  address           String?
  gender            String?
  role              UserRole         @default(USER)
  status            AccountStatus    @default(ACTIVE)
  nativeLanguage    String?
  learningLanguages String[]
  timezone          String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  lastLoginAt       DateTime?
  accounts          Account[]
  comments          Comment[]
  enrollments       Enrollment[]
  jobApplications   JobApplication[]
  progress          Progress[]
  savedItems        SavedItem[]
  sessions          Session[]
  testAttempts      TestAttempt[]

  @@index([email])
  @@index([status, role])
  @@index([name])
  @@index([createdAt])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String   @id
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Course {
  id              String        @id @default(cuid())
  slug            String        @unique
  title           String
  description     String
  language        String
  level           LanguageLevel
  status          CourseStatus  @default(DRAFT)
  thumbnail       String?
  coverImage      String?
  duration        Int?
  lessonsCount    Int           @default(0)
  studentsCount   Int           @default(0)
  metaTitle       String?
  metaDescription String?
  order           Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  publishedAt     DateTime?
  enrollments     Enrollment[]
  lessons         Lesson[]
  mockTests       MockTest[]

  @@index([language, level, status])
  @@index([slug])
  @@index([status, publishedAt])
  @@index([title])
  @@index([createdAt])
  @@index([lessonsCount])
  @@index([studentsCount])
  @@map("courses")
}

model Lesson {
  id          String     @id @default(cuid())
  courseId    String
  slug        String
  title       String
  description String?
  type        LessonType
  content     String
  attachments Json?
  duration    Int?
  order       Int
  isFree      Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  course      Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress    Progress[]

  @@unique([courseId, slug])
  @@index([courseId, order])
  @@index([title])
  @@index([isFree])
  @@map("lessons")
}

model Enrollment {
  id               String           @id @default(cuid())
  userId           String
  courseId         String
  status           EnrollmentStatus @default(ACTIVE)
  completedLessons Int              @default(0)
  progressPercent  Int              @default(0)
  enrolledAt       DateTime         @default(now())
  completedAt      DateTime?
  lastAccessedAt   DateTime?
  course           Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId, status])
  @@index([courseId])
  @@map("enrollments")
}

model Progress {
  id           String    @id @default(cuid())
  userId       String
  lessonId     String
  completed    Boolean   @default(false)
  timeSpent    Int       @default(0)
  lastPosition Int?
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  updatedAt    DateTime  @updatedAt
  lesson       Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId, completed])
  @@map("progress")
}

model MockTest {
  id               String        @id @default(cuid())
  courseId         String?
  title            String
  description      String?
  language         String?
  module           String?
  section          String?
  standardSection  String?
  type             TestType
  duration         Int
  passingScore     Int
  questionsCount   Int
  shuffleQuestions Boolean       @default(true)
  shuffleOptions   Boolean       @default(true)
  showResults      Boolean       @default(true)
  allowRetake      Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  course           Course?       @relation(fields: [courseId], references: [id])
  questions        Question[]
  attempts         TestAttempt[]

  @@index([courseId, type])
  @@index([title])
  @@index([createdAt])
  @@map("mock_tests")
}

model Question {
  id                String       @id @default(cuid())
  testId            String
  type              QuestionType
  questionText      String
  audioUrl          String?
  imageUrl          String?
  videoUrl          String?
  options           Json?
  correctAnswer     String?
  points            Int          @default(1)
  order             Int
  explanation       String?
  language          String?
  module            String?
  section           String?
  standardSection   String?
  difficulty        String?
  // Speaking-specific fields
  preparationTime   Int? // Preparation time in seconds for Part 2
  speakingTime      Int? // Speaking time in seconds
  cueCardContent    String? // Cue card content for Part 2
  followUpQuestions Json? // Follow-up questions for Part 3
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  answers           Answer[]
  test              MockTest     @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId, order])
  @@index([language, module, difficulty])
  @@map("questions")
}

model TestAttempt {
  id             String         @id @default(cuid())
  userId         String
  testId         String?
  score          Float
  correctAnswers Int
  totalQuestions Int
  passed         Boolean
  timeSpent      Int
  startedAt      DateTime       @default(now())
  completedAt    DateTime?
  answers        Answer[]
  speakingScore  SpeakingScore? // One speaking score per attempt
  test           MockTest?      @relation(fields: [testId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, testId])
  @@index([userId, completedAt])
  @@map("test_attempts")
}

model Answer {
  id             String      @id @default(cuid())
  attemptId      String
  questionId     String
  selectedOption String?
  textAnswer     String?
  jsonAnswer     Json? // For complex answers (matching, fill-blank, comprehension)
  audioUrl       String? // For speaking responses
  isCorrect      Boolean
  answeredAt     DateTime    @default(now())
  attempt        TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@map("answers")
}

model SpeakingScore {
  id               String      @id @default(cuid())
  attemptId        String      @unique
  fluencyCoherence Float // 1-9 bands
  lexicalResource  Float // 1-9 bands
  grammaticalRange Float // 1-9 bands
  pronunciation    Float // 1-9 bands
  overallBand      Float // Calculated average
  notes            String? // Examiner notes
  createdAt        DateTime    @default(now())
  attempt          TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@map("speaking_scores")
}

model JobListing {
  id               String           @id @default(cuid())
  slug             String           @unique
  title            String
  company          String
  location         String
  type             JobType
  status           JobStatus        @default(ACTIVE)
  description      String
  requirements     String
  languageRequired String
  languageLevel    LanguageLevel
  salary           String?
  currency         String?
  applicationUrl   String?
  email            String?
  viewCount        Int              @default(0)
  applicationCount Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  expiresAt        DateTime?
  applications     JobApplication[]

  @@index([languageRequired, languageLevel])
  @@index([status, expiresAt])
  @@index([company])
  @@index([location])
  @@index([title])
  @@index([createdAt])
  @@index([viewCount])
  @@map("job_listings")
}

model JobApplication {
  id          String     @id @default(cuid())
  userId      String
  jobId       String
  resumeUrl   String?
  coverLetter String?
  status      String     @default("PENDING")
  appliedAt   DateTime   @default(now())
  job         JobListing @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId, status])
  @@map("job_applications")
}

model Article {
  id              String        @id @default(cuid())
  slug            String        @unique
  title           String
  excerpt         String?
  content         String
  language        String
  category        String
  tags            String[]
  featuredImage   String?
  status          ArticleStatus @default(DRAFT)
  viewCount       Int           @default(0)
  readTime        Int?
  metaTitle       String?
  metaDescription String?
  authorId        String?
  authorName      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  publishedAt     DateTime?
  comments        Comment[]

  @@index([language, category])
  @@index([status, publishedAt])
  @@index([title])
  @@index([createdAt])
  @@index([viewCount])
  @@index([authorId])
  @@map("articles")
}

model Comment {
  id         String   @id @default(cuid())
  articleId  String
  userId     String
  content    String
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([articleId, isApproved])
  @@index([userId])
  @@map("comments")
}

model SavedItem {
  id       String        @id @default(cuid())
  userId   String
  itemType SavedItemType
  itemId   String
  notes    String?
  savedAt  DateTime      @default(now())
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType, itemId])
  @@index([userId, itemType])
  @@index([savedAt])
  @@map("saved_items")
}

model PageView {
  id        String   @id @default(cuid())
  path      String
  referrer  String?
  userId    String?
  userAgent String?
  ipAddress String?
  country   String?
  viewedAt  DateTime @default(now())

  @@index([path, viewedAt])
  @@index([userId, viewedAt])
  @@map("page_views")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum LanguageLevel {
  BEGINNER
  ELEMENTARY
  INTERMEDIATE
  UPPER_INTERMEDIATE
  ADVANCED
  PROFICIENT
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LessonType {
  VIDEO
  TEXT
  AUDIO
  INTERACTIVE
  QUIZ
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_BLANK
  MATCHING
  AUDIO_QUESTION
  SPEAKING_PART1
  SPEAKING_PART2
  SPEAKING_PART3
  WRITING
  READING_COMPREHENSION
  LISTENING_COMPREHENSION
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
}

enum JobStatus {
  ACTIVE
  FILLED
  CLOSED
  EXPIRED
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SavedItemType {
  LESSON
  ARTICLE
  JOB
}

enum TestType {
  PRACTICE
  FINAL
  CERTIFICATION
  LISTENING
  READING
  SPEAKING
  WRITING
}
